{% comment %}
  Memorial Story Submission Form Block
  Allows visitors to submit their memorial stories
{% endcomment %}

{% schema %}
{
  "name": "Story Form",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Share Your Story"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Description",
      "default": "Lost someone you love to traffic violence? Honor their memory. Share their story."
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text color",
      "default": "#ffffff"
    }
  ]
}
{% endschema %}

<div class="memorial-form-section" style="background-color: {{ block.settings.background_color }}; color: {{ block.settings.text_color }};">
  <div class="memorial-form-container">
    <div class="memorial-form-header">
      <h2 class="memorial-form-title">{{ block.settings.heading }}</h2>
      <p class="memorial-form-description">{{ block.settings.description }}</p>
    </div>

    <div id="memorial-form-wrapper">
      <!-- Form will be loaded here -->
      <div class="memorial-loading">
        <div class="memorial-loading__spinner"></div>
        <p>Loading form...</p>
      </div>
    </div>

    <div id="memorial-form-success" style="display: none;">
      <div class="memorial-success-card">
        <div class="memorial-success-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
            <path d="M20 6L9 17l-5-5" />
          </svg>
        </div>
        <h3 class="memorial-success-title">Thank You!</h3>
        <p class="memorial-success-message">Your submission has been received. We appreciate you sharing this story.</p>
        <button class="memorial-success-button" onclick="location.reload()">Submit Another Story</button>
      </div>
    </div>
  </div>
</div>

<!-- Load CSS and JS from app -->
<link rel="stylesheet" href="https://stories-app.fly.dev/assets/memorial-stories.css">
<script src="https://stories-app.fly.dev/assets/memorial-stories.js" defer></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const formWrapper = document.getElementById('memorial-form-wrapper');
    const successDiv = document.getElementById('memorial-form-success');

    // Create form HTML
    const formHTML = `
      <form id="memorial-submission-form" class="memorial-form">
        <div class="memorial-form-row">
          <div class="memorial-form-group">
            <label for="submitterName">Your Name *</label>
            <input type="text" id="submitterName" name="submitterName" required>
          </div>
          <div class="memorial-form-group">
            <label for="submitterEmail">Your Email *</label>
            <input type="email" id="submitterEmail" name="submitterEmail" required>
          </div>
        </div>

        <div class="memorial-form-row">
          <div class="memorial-form-group">
            <label for="victimName">Victim's Name</label>
            <input type="text" id="victimName" name="victimName">
          </div>
          <div class="memorial-form-group">
            <label for="relation">Your Relation to Victim</label>
            <input type="text" id="relation" name="relation">
          </div>
        </div>

        <div class="memorial-form-row">
          <div class="memorial-form-group">
            <label for="incidentDate">Incident Date *</label>
            <input type="date" id="incidentDate" name="incidentDate" required>
          </div>
          <div class="memorial-form-group">
            <label for="state">State *</label>
            <select id="state" name="state" required>
              <option value="">Select a state</option>
              <option value="California">California</option>
              <option value="New York">New York</option>
              <option value="Texas">Texas</option>
              <option value="Washington">Washington</option>
              <option value="Florida">Florida</option>
              <option value="Colorado">Colorado</option>
            </select>
          </div>
        </div>

        <div class="memorial-form-row">
          <div class="memorial-form-group">
            <label for="roadUserType">Road User Type *</label>
            <select id="roadUserType" name="roadUserType" required>
              <option value="">Select type</option>
              <option value="Cyclist">Cyclist</option>
              <option value="Pedestrian">Pedestrian</option>
              <option value="Motorcyclist">Motorcyclist</option>
            </select>
          </div>
          <div class="memorial-form-group">
            <label for="injuryType">Injury Type *</label>
            <select id="injuryType" name="injuryType" required>
              <option value="">Select type</option>
              <option value="Fatal">Fatal</option>
              <option value="Non-fatal">Non-fatal</option>
            </select>
          </div>
        </div>

        <div class="memorial-form-row">
          <div class="memorial-form-group">
            <label for="age">Age</label>
            <input type="number" id="age" name="age" min="0" max="120">
          </div>
          <div class="memorial-form-group">
            <label for="gender">Gender</label>
            <select id="gender" name="gender">
              <option value="">Select gender</option>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>

        <div class="memorial-form-group">
          <label for="victimStory">Tell Their Story *</label>
          <textarea id="victimStory" name="victimStory" rows="8" required placeholder="Share the story of your loved one..."></textarea>
        </div>

        <div class="memorial-form-group">
          <label for="photo-upload">Photos (optional, max 10)</label>
          <input
            type="file"
            id="photo-upload"
            name="photos"
            accept="image/*"
            multiple
            max="10"
          >
          <span id="file-count" style="display: block; margin-top: 0.5rem; font-size: 0.9em; color: #666;">No files selected</span>
        </div>

        <div class="memorial-form-error" id="form-error" style="display: none;"></div>

        <button type="submit" class="memorial-form-submit" id="submit-button">
          <span class="submit-text">Submit Story</span>
          <span class="submit-loading" style="display: none;">Submitting...</span>
        </button>
      </form>
    `;

    formWrapper.innerHTML = formHTML;

    // Set up shop domain for API
    window.MEMORIAL_SETTINGS = {
      shop: "{{ shop.permanent_domain }}",
      apiBaseUrl: 'https://stories-app.fly.dev/'
    };

    // Handle form submission
    const form = document.getElementById('memorial-submission-form');
    const submitButton = document.getElementById('submit-button');
    const errorDiv = document.getElementById('form-error');
    const fileInput = document.getElementById('photo-upload');
    const fileCount = document.getElementById('file-count');
    let selectedFiles = [];

    // Handle file input
    if (fileInput) {
      fileInput.addEventListener('change', function(e) {
        selectedFiles = Array.from(e.target.files);
        if (fileCount) {
          fileCount.textContent = selectedFiles.length > 0
            ? `${selectedFiles.length} file(s) selected`
            : 'No files selected';
        }
      });
    }

    form.addEventListener('submit', async function(e) {
      e.preventDefault();

      // Show loading state
      submitButton.disabled = true;
      submitButton.querySelector('.submit-text').style.display = 'none';
      submitButton.querySelector('.submit-loading').style.display = 'inline';
      errorDiv.style.display = 'none';

      // Prepare form data
      const formData = new FormData(form);

      // Initialize API and submit with files
      const api = new MemorialStoriesAPI('https://stories-app.fly.dev/');
      const result = await api.submitStory(formData, selectedFiles);

      if (result.success) {
        // Show success message
        formWrapper.style.display = 'none';
        successDiv.style.display = 'block';
      } else {
        // Show error
        errorDiv.textContent = result.error || 'Submission failed. Please try again.';
        errorDiv.style.display = 'block';

        // Reset button
        submitButton.disabled = false;
        submitButton.querySelector('.submit-text').style.display = 'inline';
        submitButton.querySelector('.submit-loading').style.display = 'none';
      }
    });
  });
</script>

<style>
  .memorial-form-section {
    padding: 80px 20px;
    min-height: 600px;
  }

  .memorial-form-container {
    max-width: 900px;
    margin: 0 auto;
  }

  .memorial-form-header {
    text-align: center;
    margin-bottom: 40px;
  }

  .memorial-form-title {
    font-size: 2.5rem;
    font-weight: 900;
    margin: 0 0 16px 0;
  }

  .memorial-form-description {
    font-size: 1.15rem;
    margin: 0;
    opacity: 0.9;
  }

  .memorial-form {
    background: #ffffff;
    padding: 40px;
    border-radius: 12px;
    color: #000000;
  }

  .memorial-form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
  }

  .memorial-form-group {
    display: flex;
    flex-direction: column;
  }

  .memorial-form-group label {
    margin-bottom: 8px;
    font-weight: 600;
    font-size: 0.95rem;
  }

  .memorial-form-group input,
  .memorial-form-group select,
  .memorial-form-group textarea {
    padding: 12px;
    border: 1px solid #d0d0d0;
    border-radius: 6px;
    font-size: 1rem;
    font-family: inherit;
  }

  .memorial-form-group textarea {
    resize: vertical;
  }

  .memorial-form-error {
    padding: 12px;
    background: #fee2e2;
    color: #dc2626;
    border-radius: 6px;
    margin-bottom: 20px;
  }

  .memorial-form-submit {
    width: 100%;
    padding: 16px;
    background: #000000;
    color: #ffffff;
    border: none;
    border-radius: 8px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .memorial-form-submit:hover:not(:disabled) {
    background: #1a1a1a;
    transform: translateY(-2px);
  }

  .memorial-form-submit:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .memorial-success-card {
    background: #ffffff;
    padding: 60px 40px;
    border-radius: 12px;
    text-align: center;
    color: #000000;
  }

  .memorial-success-icon {
    width: 80px;
    height: 80px;
    background: #22c55e;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 24px;
  }

  .memorial-success-icon svg {
    width: 48px;
    height: 48px;
    stroke: #ffffff;
  }

  .memorial-success-title {
    font-size: 2rem;
    font-weight: 700;
    margin: 0 0 16px 0;
  }

  .memorial-success-message {
    font-size: 1.05rem;
    margin: 0 0 32px 0;
    color: #333333;
  }

  .memorial-success-button {
    padding: 14px 32px;
    background: #000000;
    color: #ffffff;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .memorial-success-button:hover {
    background: #1a1a1a;
    transform: translateY(-2px);
  }

  @media (max-width: 768px) {
    .memorial-form-row {
      grid-template-columns: 1fr;
    }

    .memorial-form {
      padding: 24px;
    }

    .memorial-form-title {
      font-size: 2rem;
    }
  }
</style>
